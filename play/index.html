<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ORBITAL FLIGHT SIMULATOR</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', monospace; user-select: none; }
        canvas { display: block; }

        /* --- HUD --- */
        #ui-layer {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .hud-top {
            display: flex; justify-content: space-between; padding: 20px;
            background: linear-gradient(to bottom, rgba(0,10,20,0.8), transparent);
        }

        .stat-box { text-shadow: 0 0 10px currentColor; }
        .big-text { font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        .sub-text { font-size: 14px; opacity: 0.8; font-weight: bold; }

        /* Health Bar styling reused as Power/Integrity */
        .hp-container { width: 250px; height: 8px; background: #001122; margin-top: 5px; border: 1px solid #00ffff; transform: skewX(-15deg); }
        .hp-fill { width: 100%; height: 100%; background: #00ffff; }

        /* Artificial Horizon */
        #horizon-wrapper {
            position: absolute; top: 50%; left: 50%;
            width: 400px; height: 400px;
            transform: translate(-50%, -50%);
            overflow: hidden; opacity: 0.6;
        }
        #horizon-line {
            position: absolute; top: 50%; left: -50%; right: -50%;
            height: 2px; background: rgba(0, 255, 255, 0.8);
            box-shadow: 0 0 10px cyan;
            /* Rotated via JS */
        }
        #horizon-wrapper::after {
            /* Center reference dot */
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #ff0055; transform: translate(-50%,-50%);
        }

        /* Bottom Info */
        .hud-bottom {
            padding: 20px; text-align: center;
            background: linear-gradient(to top, rgba(0,10,20,0.8), transparent);
            color: #88aaff; font-size: 12px;
        }

        /* Upload Button */
        .upload-btn {
            pointer-events: auto; cursor: pointer;
            background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff;
            color: #00ffff; padding: 4px 12px; font-size: 11px;
            text-decoration: none; display: inline-block; margin-top: 8px;
        }
        input[type="file"] { display: none; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-box" style="color: #00ffff;">
                <div class="sub-text">SYSTEM INTEGRITY</div>
                <div class="hp-container"><div class="hp-fill"></div></div>
                <label class="upload-btn">
                    CHANGE VESSEL
                    <input type="file" id="fileInput" accept=".glb,.gltf,.png,.jpg">
                </label>
            </div>
            <div class="stat-box" style="color: #ffffff; text-align: right;">
                <div class="big-text"><span id="alt">0</span> KM</div>
                <div class="sub-text" style="color: #88aaff;">ALTITUDE</div>
                <div class="sub-text" style="margin-top:5px; color: #ffaa00;">VELOCITY: <span id="vel">0</span> MACH</div>
            </div>
        </div>

        <div id="horizon-wrapper"><div id="horizon-line"></div></div>

        <div class="hud-bottom">
            WASD: Pitch/Yaw (Smoothed) | SHIFT: Warp Thrusters | MOUSE: Look
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- CONFIG ---
        const EARTH_RADIUS = 200;
        const MOON_DISTANCE = 4000;
        const SETTINGS = {
            turnSpeed: 0.8, pitchSpeed: 0.6, inertia: 0.92,
            normalThrust: 50, warpThrust: 500
        };

        // --- SCENE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 20000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        // Cinematic tone mapping
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        document.body.appendChild(renderer.domElement);

        // --- LIGHTS ---
        const ambient = new THREE.AmbientLight(0x111111);
        scene.add(ambient);
        // THE SUN
        const sun = new THREE.DirectionalLight(0xffffff, 3.0);
        sun.position.set(1000, 500, 1000); // Top right sun position
        scene.add(sun);

        // --- CELESTIAL BODIES ---
        const textureLoader = new THREE.TextureLoader();
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        // Earth
        const earthGeo = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            bumpMap: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 5,
            specularMap: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            specular: new THREE.Color('grey'),
            shininess: 10
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // Atmosphere Glow
        const atmosMat = new THREE.MeshBasicMaterial({
            color: 0x4488ff, transparent: true, opacity: 0.1, side: THREE.BackSide, blending: THREE.AdditiveBlending
        });
        const atmosphere = new THREE.Mesh(new THREE.SphereGeometry(EARTH_RADIUS * 1.03, 64, 64), atmosMat);
        earthGroup.add(atmosphere);

        // Moon
        const moonGeo = new THREE.SphereGeometry(50, 32, 32);
        const moonMat = new THREE.MeshStandardMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/moon_1024.jpg'),
            roughness: 0.8
        });
        const moon = new THREE.Mesh(moonGeo, moonMat);
        moon.position.set(0, 0, -MOON_DISTANCE);
        scene.add(moon);

        // Stars
        const starsGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<10000; i++) {
            const r = 8000 + Math.random() * 4000;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            starPos.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
        }
        starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starsGeo, new THREE.PointsMaterial({color:0xaaaaaa, size: 1.5}));
        scene.add(stars);

        // --- PLAYER ---
        const playerGroup = new THREE.Group();
        // Start in orbit
        playerGroup.position.set(0, EARTH_RADIUS + 50, 0);
        scene.add(playerGroup);
        
        let playerShip;
        const defaultMat = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.3, metalness: 0.8 });
        const createShip = () => {
            const hull = new THREE.Mesh(new THREE.ConeGeometry(1, 5, 8), defaultMat);
            hull.rotation.x = Math.PI/2;
            const wings = new THREE.Mesh(new THREE.BoxGeometry(6, 0.2, 3), defaultMat);
            wings.position.z = 1;
            playerShip = new THREE.Group();
            playerShip.add(hull); playerShip.add(wings);
            playerGroup.add(playerShip);
        };
        createShip();

        // --- INPUT & PHYSICS ---
        const keys = { w:false, a:false, s:false, d:false, shift:false };
        const velocity = { thrust: 0, pitch: 0, yaw: 0 };
        
        window.addEventListener('keydown', e => {
            if(keys[e.key.toLowerCase()] !== undefined) keys[e.key.toLowerCase()] = true;
            if(e.key === 'Shift') keys.shift = true;
        });
        window.addEventListener('keyup', e => {
            if(keys[e.key.toLowerCase()] !== undefined) keys[e.key.toLowerCase()] = false;
            if(e.key === 'Shift') keys.shift = false;
        });

        // --- MAIN LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // --- 1. PHYSICS CONTROLS (Smoothed) ---
            const targetPitch = (keys.w ? 1 : 0) - (keys.s ? 1 : 0);
            const targetYaw = (keys.a ? 1 : 0) - (keys.d ? 1 : 0);
            
            velocity.pitch += (targetPitch * SETTINGS.pitchSpeed - velocity.pitch) * (1 - SETTINGS.inertia);
            velocity.yaw += (targetYaw * SETTINGS.turnSpeed - velocity.yaw) * (1 - SETTINGS.inertia);
            
            playerGroup.rotateX(velocity.pitch * delta);
            playerGroup.rotateY(velocity.yaw * delta);

            // Visual Banking
            playerShip.rotation.z = THREE.MathUtils.lerp(playerShip.rotation.z, velocity.yaw * 0.5, 0.1);

            // Thrust
            const targetThrust = keys.shift ? SETTINGS.warpThrust : SETTINGS.normalThrust;
            velocity.thrust += (targetThrust - velocity.thrust) * 0.05;
            playerGroup.translateZ(-velocity.thrust * delta);

            // Slow rotation of Earth/Moon
            earthGroup.rotation.y += 0.0001;
            moon.rotation.y += 0.0005;

            // --- 2. ARTIFICIAL HORIZON HUD ---
            // Calculate pitch/roll relative to global Y axis
            const euler = new THREE.Euler().setFromQuaternion(playerGroup.quaternion, 'YXZ');
            const rollDeg = -THREE.MathUtils.radToDeg(euler.z);
            const pitchDeg = THREE.MathUtils.radToDeg(euler.x);
            const horizonLine = document.getElementById('horizon-line');
            // Clamp pitch visualization so it doesn't fly off screen
            const clampedPitch = Math.max(-150, Math.min(150, pitchDeg * 2));
            horizonLine.style.transform = `rotate(${rollDeg}deg) translateY(${clampedPitch}px)`;

            // --- 3. HUD DATA ---
            // Altitude: Distance to earth center minus radius
            const distToEarth = playerGroup.position.distanceTo(earth.position);
            const altitude = Math.max(0, distToEarth - EARTH_RADIUS);
            document.getElementById('alt').innerText = altitude.toFixed(1);
            // Velocity display
            document.getElementById('vel').innerText = (velocity.thrust / 20).toFixed(1);


            // --- 4. CAMERA CHASE ---
            const camTarget = new THREE.Vector3(0, 8 + (velocity.thrust/100), 20 + (velocity.thrust/30));
            camTarget.applyMatrix4(playerGroup.matrixWorld);
            camera.position.lerp(camTarget, 0.1);
            camera.lookAt(playerGroup.position.clone().translateZ(-100));

            renderer.render(scene, camera);
        }

        // --- UPLOAD ---
        const loader = new GLTFLoader();
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            if(file.name.match(/\.(glb|gltf)$/i)) {
                loader.load(url, gltf => {
                    playerShip.clear(); const model = gltf.scene;
                    const box = new THREE.Box3().setFromObject(model);
                    model.scale.setScalar(5 / Math.max(box.max.x-box.min.x, box.max.y-box.min.y, box.max.z-box.min.z));
                    model.rotation.y = Math.PI; playerShip.add(model);
                });
            } else if(file.name.match(/\.(png|jpg)$/i)) {
                new THREE.TextureLoader().load(url, tex => {
                    playerShip.clear(); const aspect = tex.image.height/tex.image.width;
                    const plane = new THREE.Mesh(new THREE.PlaneGeometry(5, 5*aspect), new THREE.MeshBasicMaterial({ map:tex, transparent:true, side:THREE.DoubleSide }));
                    plane.rotation.x = -Math.PI/2; plane.rotation.y = Math.PI; playerShip.add(plane);
                });
            }
        });

        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
